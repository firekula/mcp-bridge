# MCP Bridge æ’ä»¶ä»£ç å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2026-02-02  
**å®¡æŸ¥äºº**: AI Assistant

## ğŸ“‹ å®¡æŸ¥æ¦‚è¦

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| ä»£ç è¡Œæ•° | `main.js` (1560è¡Œ), `scene-script.js` (560è¡Œ) |
| æµ‹è¯•è„šæœ¬ | 4ä¸ª (`run_tests.js`, `test_find_file.js`, `test_undo.js`, `test_vfx.js`) |
| åŠŸèƒ½å®Œæˆåº¦ | **é«˜** - å¤§éƒ¨åˆ†æ ¸å¿ƒåŠŸèƒ½å·²å®ç° |
| ä»£ç è´¨é‡ | **ä¸­ç­‰** - å­˜åœ¨é‡å¤ä»£ç å’Œç»“æ„é—®é¢˜ |

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜ (éœ€è¦ç«‹å³ä¿®å¤)

### 1. é‡å¤å‡½æ•°å®šä¹‰ (ä¸¥é‡)

åœ¨ `main.js` ä¸­å‘ç°ä»¥ä¸‹é‡å¤å®šä¹‰çš„å‡½æ•°ï¼š

| å‡½æ•°å | ç¬¬ä¸€æ¬¡å‡ºç° | ç¬¬äºŒæ¬¡å‡ºç° |
|--------|-----------|-----------|
| `validateScript` | è¡Œ 1337-1369 | è¡Œ 1424-1456 |
| `get-server-state` (message) | è¡Œ 1375-1377 | è¡Œ 1408-1415 |
| `executeMenuItem` | è¡Œ 1243-1254 | è¡Œ 1317-1335 (åŒåä½†å®ç°ä¸åŒ) |

> âš ï¸ **è­¦å‘Š**: é‡å¤å‡½æ•°ä¼šå¯¼è‡´åå®šä¹‰çš„è¦†ç›–å…ˆå®šä¹‰çš„ï¼Œå¯èƒ½é€ æˆæ„å¤–è¡Œä¸ºã€‚ç¬¬äºŒä¸ª `validateScript` (è¡Œ 1424-1456) ä½¿ç”¨äº† `loadMeta` è€Œä¸æ˜¯ `loadAny`ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®è¯»å–è„šæœ¬å†…å®¹ã€‚

**å»ºè®®ä¿®å¤**:
- åˆ é™¤é‡å¤çš„ `validateScript` å‡½æ•° (ä¿ç•™è¡Œ 1337-1369 çš„ç‰ˆæœ¬ï¼Œå®ƒä½¿ç”¨ `loadAny`)
- åˆå¹¶ä¸¤ä¸ª `get-server-state` æ¶ˆæ¯å¤„ç†å™¨ (ç¬¬äºŒä¸ªæ›´å®Œæ•´ï¼ŒåŒ…å« `autoStart`)
- å®¡æŸ¥å¹¶åˆå¹¶ä¸¤ä¸ª `executeMenuItem` çš„å®ç°

---

### 2. TypeScript è„šæœ¬éªŒè¯ç¼ºå¤±

```javascript
// å¯¹äº TypeScript è„šæœ¬ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„éªŒè¯é€»è¾‘
callback(null, { valid: true, message: 'Script syntax is valid' });
```

`validate_script` å·¥å…·å¯¹ TypeScript `.ts` æ–‡ä»¶æ²¡æœ‰å®é™…éªŒè¯é€»è¾‘ï¼Œç›´æ¥è¿”å› valid: trueã€‚

**å»ºè®®ä¿®å¤**:
- é›†æˆ TypeScript ç¼–è¯‘å™¨è¿›è¡Œè¯­æ³•æ£€æŸ¥
- æˆ–è€…ä½¿ç”¨ `require('typescript').transpileModule()` è¿›è¡ŒåŸºæœ¬éªŒè¯

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜ (å»ºè®®ä¿®å¤)

### 3. èœå•é¡¹æ‰§è¡ŒåŠŸèƒ½å—é™

```javascript
// é€šç”¨å°è¯• (å¯èƒ½ä¸å·¥ä½œï¼Œå–å†³äºç¼–è¾‘å™¨ç‰ˆæœ¬)
// Editor.Ipc.sendToMain('ui:menu-click', menuPath); 
// å…œåº•ï¼šä»…è®°å½•æ—¥å¿—ï¼Œæš‚ä¸æ”¯æŒé€šç”¨èœå•ç‚¹å‡»
addLog("warn", "Generic menu execution partial support.");
```

`execute_menu_item` å·¥å…·åªå¯¹ `File/Save Scene` æœ‰å®é™…ä½œç”¨ï¼Œå…¶ä»–èœå•é¡¹ä»…è®°å½•æ—¥å¿—ã€‚

**å»ºè®®ä¿®å¤**:
- è°ƒç ” Cocos Creator 2.4.x çš„èœå•æ‰§è¡Œ IPC æ¥å£
- æˆ–è€…æ·»åŠ å¸¸ç”¨èœå•é¡¹çš„æ˜ å°„è¡¨

---

### 4. é¢œè‰²å±æ€§ Undo ä¸æ”¯æŒ

```javascript
// æš‚ä¸”å¿½ç•¥é¢œè‰²çš„ Undoï¼Œå…ˆä¿è¯ Transform çš„ Undoã€‚
Editor.Scene.callSceneScript("mcp-bridge", "update-node-transform", { id, color }, (err) => {
    if (err) addLog("warn", "Color update failed or partial");
});
```

`update_node_transform` ä¸­ä½ç½®å’Œç¼©æ”¾ä½¿ç”¨ `scene:set-property` æ”¯æŒ Undoï¼Œä½†é¢œè‰²é€šè¿‡ scene-script ä¿®æ”¹ï¼Œä¸æ”¯æŒ Undoã€‚

**å»ºè®®ä¿®å¤**:
- ç ”ç©¶å¦‚ä½•é€šè¿‡ `scene:set-property` è®¾ç½®é¢œè‰²å±æ€§

---

### 5. æè´¨/çº¹ç†åˆ›å»ºåŠŸèƒ½ä¸å®Œæ•´

`manage_material` å’Œ `manage_texture` çš„ `create` æ“ä½œåˆ›å»ºçš„æ˜¯ JSON å…ƒæ•°æ®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„æè´¨æˆ–çº¹ç†èµ„æºã€‚

```javascript
// åˆ›å»ºæè´¨èµ„æº
const materialContent = JSON.stringify({
    __type__: "cc.Material",
    // ...
});
```

**å»ºè®®ä¿®å¤**:
- æ–‡æ¡£ä¸­è¯´æ˜æ­¤å·¥å…·çš„é™åˆ¶
- æˆ–è€…ä½¿ç”¨ Cocos Creator çš„èµ„æºåˆ›å»º API

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜ (å¯ä¼˜åŒ–)

### 6. ç¼ºå¤±çš„åŠŸèƒ½æ¨¡å—

æ ¹æ® `DEVELOPMENT_PLAN.md`ï¼Œä»¥ä¸‹åŠŸèƒ½æœªå®Œå…¨å®ç°æˆ–å¯æ‰©å±•ï¼š

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Git é›†æˆ (`get_sha`) | âŒ æœªå®ç° | è·å–å½“å‰ç‰ˆæœ¬åº“ä¿¡æ¯ |
| ScriptableObject ç®¡ç† | âŒ æœªå®ç° | ç±»ä¼¼ Unity çš„ ScriptableObject |
| å›½é™…åŒ–æ”¯æŒ | âŒ æœªå®ç° | å¤šè¯­è¨€ç•Œé¢ |
| æ’ä»¶å•†åº—å‘å¸ƒ | âŒ æœªå®Œæˆ | æ‰“åŒ…å’Œå‘å¸ƒæµç¨‹ |

---

### 7. ä»£ç ç»“æ„ä¼˜åŒ–å»ºè®®

1. **æ‹†åˆ† `main.js`**: 1560 è¡Œä»£ç è¿‡äºåºå¤§ï¼Œå»ºè®®æ‹†åˆ†ä¸ºï¼š
   - `tools/scene-tools.js` - åœºæ™¯ç›¸å…³å·¥å…·
   - `tools/asset-tools.js` - èµ„æºç®¡ç†å·¥å…·
   - `tools/editor-tools.js` - ç¼–è¾‘å™¨æ§åˆ¶å·¥å…·

2. **ç»Ÿä¸€é”™è¯¯å¤„ç†**: éƒ¨åˆ†å‡½æ•°ç›´æ¥ `return callback(error)`ï¼Œéƒ¨åˆ†ä½¿ç”¨ `callback(err, null)`ï¼Œå»ºè®®ç»Ÿä¸€é£æ ¼ã€‚

3. **æ·»åŠ  JSDoc æ³¨é‡Š**: æ ¸å¿ƒå‡½æ•°ç¼ºå°‘æ–‡æ¡£æ³¨é‡Šã€‚

---

### 8. æµ‹è¯•è¦†ç›–ä¸å®Œæ•´

ç›®å‰æµ‹è¯•è„šæœ¬ä»…è¦†ç›–ï¼š
- âœ… åŸºç¡€è¿æ¥å’ŒèŠ‚ç‚¹æ“ä½œ (`run_tests.js`)
- âœ… æ–‡ä»¶æœç´¢ (`test_find_file.js`)
- âœ… æ’¤é”€/é‡åš (`test_undo.js`)
- âœ… ç²’å­ç³»ç»Ÿ (`test_vfx.js`)

æœªè¦†ç›–çš„åŠŸèƒ½ï¼š
- âŒ `manage_material` / `manage_texture`
- âŒ `scene_management` / `prefab_management`
- âŒ `apply_text_edits`
- âŒ `batch_execute`

---

## ğŸ“Œ ä¿®å¤ä¼˜å…ˆçº§æ’åº

| åºå· | é—®é¢˜ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|------|--------|----------|
| 1 | åˆ é™¤é‡å¤å‡½æ•° | ğŸ”´ é«˜ | 0.5h |
| 2 | åˆå¹¶ `get-server-state` | ğŸ”´ é«˜ | 0.5h |
| 3 | TypeScript éªŒè¯ | ğŸŸ¡ ä¸­ | 2h |
| 4 | èœå•æ‰§è¡Œå¢å¼º | ğŸŸ¡ ä¸­ | 1h |
| 5 | é¢œè‰² Undo æ”¯æŒ | ğŸŸ¡ ä¸­ | 1h |
| 6 | æµ‹è¯•è¦†ç›–æ‰©å±• | ğŸŸ¢ ä½ | 4h |
| 7 | ä»£ç æ‹†åˆ†é‡æ„ | ğŸŸ¢ ä½ | 8h |

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®

1. **ç«‹å³ä¿®å¤**: åˆ é™¤ `main.js` ä¸­çš„é‡å¤å‡½æ•°å®šä¹‰
2. **çŸ­æœŸ**: å®Œå–„ TypeScript éªŒè¯å’Œæµ‹è¯•è¦†ç›–
3. **ä¸­æœŸ**: ä¼˜åŒ–ä»£ç ç»“æ„ï¼Œæ‹†åˆ†å¤§æ–‡ä»¶
4. **é•¿æœŸ**: å®ç° Git é›†æˆï¼Œå‡†å¤‡æ’ä»¶å•†åº—å‘å¸ƒ

---

## ğŸ“ é™„å½•ï¼šå·²å®ç°åŠŸèƒ½æ¸…å•

| å·¥å…·åç§° | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| `get_selected_node` | âœ… | è·å–é€‰ä¸­èŠ‚ç‚¹ |
| `set_node_name` | âœ… | ä¿®æ”¹èŠ‚ç‚¹åç§° |
| `save_scene` | âœ… | ä¿å­˜åœºæ™¯ |
| `get_scene_hierarchy` | âœ… | è·å–åœºæ™¯å±‚çº§ |
| `update_node_transform` | âœ… | ä¿®æ”¹èŠ‚ç‚¹å˜æ¢ |
| `create_scene` | âœ… | åˆ›å»ºåœºæ™¯ |
| `create_prefab` | âœ… | åˆ›å»ºé¢„åˆ¶ä½“ |
| `open_scene` | âœ… | æ‰“å¼€åœºæ™¯ |
| `create_node` | âœ… | åˆ›å»ºèŠ‚ç‚¹ |
| `manage_components` | âœ… | ç®¡ç†ç»„ä»¶ |
| `manage_script` | âœ… | ç®¡ç†è„šæœ¬ |
| `batch_execute` | âœ… | æ‰¹é‡æ‰§è¡Œ |
| `manage_asset` | âœ… | ç®¡ç†èµ„æº |
| `scene_management` | âœ… | åœºæ™¯ç®¡ç† |
| `prefab_management` | âœ… | é¢„åˆ¶ä½“ç®¡ç† |
| `manage_editor` | âœ… | ç¼–è¾‘å™¨ç®¡ç† |
| `find_gameobjects` | âœ… | æŸ¥æ‰¾èŠ‚ç‚¹ |
| `manage_material` | âš ï¸ | éƒ¨åˆ†å®ç° |
| `manage_texture` | âš ï¸ | éƒ¨åˆ†å®ç° |
| `execute_menu_item` | âš ï¸ | éƒ¨åˆ†å®ç° |
| `apply_text_edits` | âœ… | æ–‡æœ¬ç¼–è¾‘ |
| `read_console` | âœ… | è¯»å–æ§åˆ¶å° |
| `validate_script` | âš ï¸ | ä»…æ”¯æŒ JS |
| `find_in_file` | âœ… | æ–‡ä»¶æœç´¢ |
| `manage_undo` | âœ… | æ’¤é”€/é‡åš |
| `manage_vfx` | âœ… | ç²’å­ç³»ç»Ÿ |
